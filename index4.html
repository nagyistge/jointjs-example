<!DOCTYPE html>
<html lang="en">
<head>
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="vendors/css/joint.css">
    <link rel="stylesheet" type="text/css" href="css/devs.css">
    <link rel="stylesheet" type="text/css" href="css/custom.css">

    <meta charset="UTF-8">
    <title></title>
</head>

<style type="text/css">
    .baseCircle {
        stroke-opacity: 0.9;
        stroke: green;
        stroke-width: 2px;
        fill: white;
    }
    .dragTarget {
        stroke: green;
        stroke-width: 2px;
        fill: white;
    }
    .circleAddedClass {
        stroke: black;
        stroke-width: 2px;
        fill: white;
    }
</style>
<body>

<script src="vendors/js/jquery.min.js"></script>
<script src="vendors/js/lodash.min.js"></script>
<script src="vendors/js/backbone.min.js"></script>
<script src="vendors/js/joint_093.js"></script>

<script src="vendors/js/joint.shapes.devs.js"></script>

<script>
    // unique id for circles
    function guid() {
        function _p8(s) {
            var p = (Math.random().toString(16) + "000000000").substr(2, 8);
            return s ? "-" + p.substr(0, 4) + "-" + p.substr(4, 4) : p;
        }
        return _p8() + _p8(true) + _p8(true) + _p8();
    }

    function getNode(d3Element) {
        return d3Element[0][0];
    }

    // check if within bounds
    function isWithin(x, y, box) {
        return (x >= box.x && x <= (box.x + box.width) && y >= box.y && y <= (box.y + box.height))
    }

    function getTranslate(t) {
        var translate = d3.transform(t.getAttribute("transform")).translate;
        return {
            x: Number(translate[0]),
            y: Number(translate[1])
        };
    }


    var svg = d3.select("body")
            .append("svg")
            .attr("width", 800)
            .attr("height", 803);


    // movement for a transformed element
    var dragG = d3.behavior.drag()
        // set the origin to the start position
            .origin(function () {
                return getTranslate(this);
            })
            .on("drag", function () {
                d3.select(this).attr(
                        "transform",
                        "translate(" + d3.event.x + "," + d3.event.y + ")");
            });

    // drop group
    var targetG = svg.append("g")
            .style('cursor', 'move')
            .attr("transform", "translate(150,150)")
            .call(dragG)

    // append rectangle to group
    targetG.append("rect")
            .attr("fill", "none")
            .style("stroke", "black")
            .style("stroke-width", "2px")
            .attr("width", 200)
            .attr("height", 200)
            .style("fill", "white");


    // drag functions
    var draggedCircle;
    var circleDrag = function () {
        draggedCircle.attr("cx", d3.event.x)
                .attr("cy", d3.event.y);
    }

    function circleDragEnd() {
        // get event x and y
        var dx = Number(draggedCircle.attr("cx"));
        var dy = Number(draggedCircle.attr("cy"));
        if (draggedCircle.classed("circleAddedClass")) {
            var t = getTranslate(getNode(draggedCircle).parentNode);
            console.log([dx, dy])
            dx += t.x;
            dy += t.y;
            console.log([dx, dy])
        }

        svg.selectAll("g").each(function () {
            var rect = d3.select(this).select("rect");
            if (rect.length === 1) {
                var box = getNode(rect).getBBox();

                // the actual coordinates of the element must include the parent's transform too
                var t = getTranslate(this);
                box = {
                    x: box.x + t.x,
                    y: box.y + t.y,
                    width: box.width,
                    height: box.height
                }

                if (isWithin(dx, dy, box)) {
                    if (!draggedCircle.classed("circleAddedClass")) {
                        draggedCircle = draggedCircle.remove()
                                .attr("cx", dx - t.x)
                                .attr("cy", dy - t.y)
                                .attr("id", guid())
                                .classed("dragTarget", false)
                                .classed("circleAddedClass", true);

                        // append target circle to g element
                        this.appendChild(getNode(draggedCircle))
                    }
                } else if (draggedCircle.classed("circleAddedClass")) {
                    if (getNode(draggedCircle).parentNode === this) {
                        draggedCircle = draggedCircle.remove()
                                .attr("cx", dx)
                                .attr("cy", dy)
                                .classed("dragTarget", true)
                                .classed("circleAddedClass", false);

                        getNode(svg).appendChild(getNode(draggedCircle))
                    }
                }
            }
        });
    }

    // drag behaviour for circle instances
    var dragCircleInstance = d3.behavior.drag()
            .on("dragstart", function () {
                draggedCircle = d3.select(this)
                d3.event.sourceEvent.stopPropagation();
            })
            .on("drag", circleDrag)
            .on("dragend", circleDragEnd);

    // drag behaviour for circle template
    var dragCircleTemplate = d3.behavior.drag()
            .on("dragstart", function () {
                draggedCircle = svg.append("circle")
                        .attr("r", 25) //get radius from targetCircle and also styles?
                        .attr("cx", d3.select(this).attr("cx"))
                        .attr("cy", d3.select(this).attr("cy"))
                        .classed("dragTarget", true)
                        .call(dragCircleInstance);
            })
            .on("drag", circleDrag)
            .on("dragend", circleDragEnd);

    // draw the circle template
    var circle = svg.append("circle")
            .attr("r", 25)
            .attr("cx", 35)
            .attr("cy", 145)
            .classed("baseCircle", true)
            .call(dragCircleTemplate);
</script>
</body>

</html>
