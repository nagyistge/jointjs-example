<!DOCTYPE html>
<html lang="en">
<head>
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="vendors/css/joint.css">
    <link rel="stylesheet" type="text/css" href="css/devs.css">
    <link rel="stylesheet" type="text/css" href="css/custom.css">

    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<div id="paper2" class="paper" style="border-style: solid;border-width: 5px;width:600px"></div>
<div id="paper" class="paper" style="border-style: solid;border-width: 5px;width:600px"></div>

<script src="vendors/js/jquery.min.js"></script>
<script src="vendors/js/lodash.min.js"></script>
<script src="vendors/js/backbone.min.js"></script>
<script src="vendors/js/joint_093.js"></script>

<script src="vendors/js/joint.shapes.devs.js"></script>

<script>
    var ClickableView = joint.dia.ElementView.extend({
        pointerdown: function () {
            this._click = true;
            joint.dia.ElementView.prototype.pointerdown.apply(this, arguments);
        },
        pointermove: function () {
            this._click = false;
            joint.dia.ElementView.prototype.pointermove.apply(this, arguments);
        },
        pointerup: function (evt, x, y) {
            if (this._click) {
                this.notify('cell:click', evt, x, y);
            } else {
                joint.dia.ElementView.prototype.pointerup.apply(this, arguments);
            }
        }
    });



    var graph = new joint.dia.Graph;
    var paper = new joint.dia.Paper({
        el: $('#paper'),
        width: 600,
        height: 200,
        model: graph,
        gridSize: 1
    });
    var rect = new joint.shapes.basic.Rect({
        position: { x: 100, y: 30 },
        size: { width: 100, height: 30 },
        attrs: { rect: { fill: 'blue' }, text: { text: 'my box', fill: 'white' } }
    });
    graph.addCells([rect]);

    var graph2 = new joint.dia.Graph;
    var paper2 = new joint.dia.Paper({
        el: $('#paper2'),
        width: 600,
        height: 200,
        model: graph2,
        gridSize: 1,
        elementView: ClickableView,
        interactive: false
    });

    var newElement = null, body = null;

    paper2.on('cell:pointermove',function (cellView, evt, x, y) {
        body.bind('mousemove', function(e){

            console.log('pointermove')
            if (!createdElement) {
                createdElement = $("div.box");
                createdElement.css('visibility', 'visible');
            }

            var mouseX   =  e.pageX - cellView.model.getBBox().width / 2;
            var mouseY   =  e.pageY - cellView.model.getBBox().height / 2;
            createdElement.offset({ top: mouseY, left: mouseX });
        });
    });

    var paperMain = null, paperControls = null;

    function allowToDragDrop(event){
        if (!event) return false;
        paperMain = paperMain || $('#paper');

        var offset = paperMain.offset();
        var x = event.clientX, y = event.clientY;

        if (x >= offset.left && x <= offset.left + paperMain.width()) {
            if (y >= offset.top && y <= offset.top + paperMain.height())
                return true;
        }

        return false;
    }

    function clearDraggedData(){
        if (body){
            body.off('mousemove');
        }

        newElement.remove();
        newElement = null;

        if (createdElement){
            createdElement.remove();
            createdElement = null;
        }

        if (paper3) {
            paper3.remove();
            graph3.clear();
        }
    }

    paper2.on('cell:pointerup',function (cellView, evt, x, y) {
        if (!allowToDragDrop(evt)) {
            clearDraggedData();
            return;
        }

        // clear created element
        if (newElement){
            var draggedElement = newElement.clone();
            var bbox = draggedElement.getBBox();

            draggedElement.position(evt.clientX - bbox.width / 2 - paperMain.offset().left,
                    evt.clientY - bbox.height - paperMain.offset().top + document.body.scrollTop);
//            draggedElement.position(evt.offsetX, evt.offsetY);

            graph.addCells([draggedElement]);
            clearDraggedData();
        }
    });

    var graph3, paper3;
    var createdElement;

    paper2.on('cell:pointerdown',function (cellView, evt, x, y) {
        if (newElement) return;
        body = body || $('body');
        body.append('<div id="flyPaper" class="box" style="z-index: 100;display:block;opacity:.7; visibility: hidden"></div>');
        newElement = cellView.model.clone();
        newElement.position(0, 0);

        graph3 = graph3 || new joint.dia.Graph;
        paper3 = new joint.dia.Paper({
            el: $('#flyPaper'),
            width: paper2.options.width,
            height: paper2.options.height,
            model: graph3,
            gridSize: 1
        });
        graph3.addCells([newElement]);
    });






    var rect2 = new joint.shapes.basic.Rect({
        position: { x: 10, y: 50 },
        size: { width: 100, height: 30 },
        attrs: { rect: { fill: 'blue' }, text: { text: 'my box', fill: 'white' } }
    });
    graph2.addCells([rect2]);



</script>
</body>

</html>
